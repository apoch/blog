<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Epoch 64-bit self-hosting progress</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Epoch 64-bit self-hosting progress">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Epoch 64-bit self-hosting progress">
    <meta property="og:description" content="">

    <!-- <meta name="twitter:site" content="">

<meta name="twitter:creator" content="">

<meta name="google-site-verification" content="">

<meta property="fb:admins" content="">
 -->

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">

    <link href="//fonts.googleapis.com/" rel="dns-prefetch">
    <link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Open+Sans:700,400&subset=latin,latin-ext" rel="stylesheet">

    <link rel="stylesheet" href="//apoch.github.io/blog/themes/ghostium/assets/css/main.min.css?v=1496373426181"/>
    <link rel="stylesheet" href="//apoch.github.io/blog/themes/ghostium/assets/css/custom.css?v=1496373426181"/>
    <link rel="stylesheet" href="//apoch.github.io/blog/themes/ghostium/assets/css/asciidoctor-foundation.css?v=1496373426181"/>




    <script type="text/javascript">
      var ga_ua = 'UA-XXXXX-X';
      
      var disqus_shortname = 'example';
      
      var enable_pjax = true;

      // Pace Options
      // ==============
      window.paceOptions = {
        catchupTime: 100,
        minTime: 100,
        elements: false,
        restartOnRequestAfter: 500,
        startOnPageLoad: false
      }

      // Ghostium Globals
      // ==============
      window.GHOSTIUM = {};
      GHOSTIUM.haveGA = typeof ga_ua !== 'undefined' && ga_ua !== 'UA-XXXXX-X';
      GHOSTIUM.haveDisqus = typeof disqus_shortname !== 'undefined' && disqus_shortname !== 'example';
      GHOSTIUM.enablePjax = typeof enable_pjax !== 'undefined' ? enable_pjax : true;
    </script>

    <script src="//apoch.github.io/blog/themes/ghostium/assets/js/head-scripts.min.js?v=1496373426181"></script>

    <link rel="canonical" href="https://apoch.github.io/blog/2017/05/29/Epoch-64-bit-self-hosting-progress.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="The Bag of Holding" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Epoch 64-bit self-hosting progress" />
    <meta property="og:description" content="For a decent while now, I&amp;#8217;ve been working on self-hosting the Epoch 64-bit compiler. This involves getting the compiler to a point where it is robust enough to actually compile itself. In order to do this, I&amp;#8217;m using a modified 32-bit compiler which generates 64-bit binaries." />
    <meta property="og:url" content="https://apoch.github.io/blog/2017/05/29/Epoch-64-bit-self-hosting-progress.html" />
    <meta property="article:published_time" content="2017-05-29T00:00:00.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Epoch 64-bit self-hosting progress" />
    <meta name="twitter:description" content="For a decent while now, I&amp;#8217;ve been working on self-hosting the Epoch 64-bit compiler. This involves getting the compiler to a point where it is robust enough to actually compile itself. In order to do this, I&amp;#8217;m using a modified 32-bit compiler which generates 64-bit binaries." />
    <meta name="twitter:url" content="https://apoch.github.io/blog/2017/05/29/Epoch-64-bit-self-hosting-progress.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "The Bag of Holding",
    "author": {
        "@type": "Person",
        "name": "Mike Lewis",
        "image": "https://avatars2.githubusercontent.com/u/321649?v=3",
        "url": "https://apoch.github.io/blog/author/apoch/",
        "sameAs": "https://apoch.github.io/",
        "description": "Guild Wars 2 Project Technical Director @arenanet and author of the Epoch programming language."
    },
    "headline": "Epoch 64-bit self-hosting progress",
    "url": "https://apoch.github.io/blog/2017/05/29/Epoch-64-bit-self-hosting-progress.html",
    "datePublished": "2017-05-29T00:00:00.000Z",
    "description": "For a decent while now, I&amp;#8217;ve been working on self-hosting the Epoch 64-bit compiler. This involves getting the compiler to a point where it is robust enough to actually compile itself. In order to do this, I&amp;#8217;m using a modified 32-bit compiler which generates 64-bit binaries."
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="The Bag of Holding" href="https://apoch.github.io/blog/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
  </head>
  <body class="post-template">

    <button data-action="open-drawer" id="drawer-button" class="drawer-button"><i class="fa fa-bars"></i></button>
    <nav tabindex="-1" class="drawer">
      <div class="drawer-container">
        <!--.drawer-search(role="search")-->
        <ul role="navigation" class="drawer-list">
          
          <li class="drawer-list-item">
            <a href="https://apoch.github.io/blog" data-pjax>
              <i class="fa fa-home"></i>Home
            </a>
          </li>
          <!-- <li class="drawer-list-item">
            <a href="https://apoch.github.io/blog" title="The Bag of Holding" data-pjax>
              <i class="fa fa-list-alt"></i>All posts
            </a>
          </li> -->
          <li class="drawer-list-item">
            <a href="https://apoch.github.io/blog/rss/">
              <i class="fa fa-rss"></i>Subscribe to Feed
            </a>
          </li>
          <li class="drawer-list-divider"></li>
          <li class="drawer-list-item drawer-list-title">
            Follow me
          </li>
          
          
          <li class="drawer-list-item">
            <a href="https://twitter.com/ApochPiQ" title="Twitter" target="_blank">
              <i class="fa fa-twitter"></i>Twitter
            </a>
          </li>
          <li class="drawer-list-item">
            <a href="https://github.com/apoch" title="Github" target="_blank">
              <i class="fa fa-github"></i>Github
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="drawer-overlay"></div>
    <main id="container" role="main" class="container">
      <div class="surface">
        <div class="surface-container">
          <div data-pjax-container class="content">
            
<section class="wrapper wrapper-post">
  <div class="wrapper-container">
    <article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post post">
        <section class="post-container">
          <header class="post-header">
            <ul class="post-meta-list">
              <li class="post-meta-item">
                <time datetime="2017-05-29" itemprop="datePublished">
                  4 days ago
                </time>
              </li>
              <li class="post-meta-item">
                <a href="#disqus_thread" data-disqus-identifier="">Comments</a>
              </li>
            </ul>
            <h1 itemprop="name headline" class="post-title"><a href="https://apoch.github.io/blog/2017/05/29/Epoch-64-bit-self-hosting-progress.html" itemprop="url" data-pjax title="Epoch 64-bit self-hosting progress">Epoch 64-bit self-hosting progress</a></h1>
            <!--h2 itemprop="about" class="post-subtitle"></h2-->
          </header>
          <aside class="post-side">
            <div class="post-author">
                <a href="https://apoch.github.io/" class="post-author-avatar">
                  <img src="https://avatars2.githubusercontent.com/u/321649?v&#x3D;3" alt="Mike Lewis">
                </a>
              <div class="post-author-info">
                <a href="https://apoch.github.io/" class="post-author-name">
                  Mike Lewis
                </a>
                <p class="post-author-bio">Guild Wars 2 Project Technical Director @arenanet and author of the Epoch programming language.</p>
              </div>
            </div>
          </aside>
          <div itemprop="articleBody" class="post-body">
            <div class="paragraph">
<p>For a decent while now, I&#8217;ve been working on <em>self-hosting</em> the <a href="https://github.com/apoch/epoch-language">Epoch</a> 64-bit compiler. This involves getting the compiler to a point where it is robust enough to actually compile itself. In order to do this, I&#8217;m using a modified 32-bit compiler which generates 64-bit binaries. Once a working 64-bit compiler is emitted, I can feed <em>that</em> compiler back into itself, thus completing the head-trip ouroboros that is self-hosting or "bootstrapping" a compiler.</p>
</div>
<div class="paragraph">
<p>At the moment, the compiler can successfully lex, parse, type-check, and partially code-gen itself. In practical terms, this means that the <em>front-end</em> of the compiler is working fine, but the <em>back-end</em> - the set of systems responsible for turning code into machine language and emitting a working executable - remains incomplete. For a slightly different perspective, I&#8217;m generating LLVM IR for <em>most</em> of the compiler at this point.</p>
</div>
<div class="paragraph">
<p>The bits that are left are corner cases in the code generation engine. There are things like intrinsic functions that need to be wired up, special semantics to implement, and so on. In particular, right now, I&#8217;m working on solving a corner case with the <code>nothing</code> concept. <code>nothing</code> is an Epoch idiom for expressing the idea that there is no data; except, unlike traditional <code>null</code>, <code>nothing</code> is its own <em>type</em>. If something has a type it cannot be <code>nothing</code> - again, unlike <code>null</code>. The usefulness of this may seem questionable, but the distinction makes it possible to avoid entire classes of runtime bugs, because you can never "forget" to write code that handles <code>nothing</code> - the compiler enforces this for you!</p>
</div>
<div class="paragraph">
<p>Anyways, the trick with <code>nothing</code> is that you can pass a literal <code>nothing</code> to a function as an argument, to signify that you have no semantically valid data to pass in. This is handled correctly by the parser and type checker, but falls down in code generation because we can&#8217;t actually omit the parameter from the function call.</p>
</div>
<div class="paragraph">
<p>What happens is the code generator creates a function with, say, 3 parameters. If the second parameter is <code>nothing</code> at a call site, we have to still pass <em>something</em> over to the function, from LLVM&#8217;s perspective. So we generate a dummy parameter that essentially translates the <code>nothing</code> semantics into <code>null</code> semantics - something LLVM can recognize.</p>
</div>
<div class="paragraph">
<p>Now things get complicated.</p>
</div>
<div class="paragraph">
<p>If we have an algebraic sum type that includes the type <code>nothing</code>, and we pass a sum-typed variable into a function which expects <em>concrete</em> types, the code goes through a process called <em>type dispatching</em>. This process basically matches an overload of a function with the <em>runtime</em> types of the arguments passed in. Think of it like virtual dispatch with no objects involved. (Strictly speaking, type dispatch in Epoch is <em>multiple dispatch</em> rather than the <em>single dispatch</em> seen in more popular languages.)</p>
</div>
<div class="paragraph">
<p>To facilitate all this, the compiler inserts <em>annotations</em> into the code, so that it can deduce what set of overloads to choose from when the runtime dispatcher is invoked. Some of these annotations survive at runtime - analogs of <em>virtual-table pointers</em> in C++.</p>
</div>
<div class="paragraph">
<p>Annotations are passed as hidden parameters on the stack when invoking a function. And at last we reach the real wrinkle: a <code>nothing</code> annotation can come from <em>two distinct places</em>: either the construction of a sum-typed variable which allows <code>nothing</code> as a base type, or a literal <code>nothing</code> passed to a function call.</p>
</div>
<div class="paragraph">
<p>The headache is that, to LLVM, <em>both uses look like a function call</em>. There is special case logic that exists to fix up the annotations for sum-typed constructors. Unfortunately, that logic collides with the logic needed to fix up annotations for general function call usage because LLVM doesn&#8217;t know the difference.</p>
</div>
<div class="paragraph">
<p>It&#8217;s an imminently solvable problem, but it&#8217;s a headache. Hopefully once this bug is gone there won&#8217;t be <em>too</em> many more to swat before I can start code-generating working 64-bit compilers.</p>
</div>
<div class="paragraph">
<p>(Spoiler: I&#8217;m not optimistic.)</p>
</div>
          </div>
          <footer class="post-footer">
            <div itemprop="author" itemscope itemtype="http://schema.org/Person" class="post-author">
                <a href="https://apoch.github.io/" class="post-author-avatar">
                  <img itemprop="image" src="https://avatars2.githubusercontent.com/u/321649?v&#x3D;3" alt="Mike Lewis">
                </a>
              <div class="post-author-info">
                <h4 class="post-footer-heading">Written By</h4>
                <a href="https://apoch.github.io/" itemprop="url" class="post-author-name">
                  <span itemprop="name">Mike Lewis</span>
                </a>
                <p itemprop="description" class="post-author-bio">Guild Wars 2 Project Technical Director @arenanet and author of the Epoch programming language.</p>
                  <p class="post-author-location">Bellevue, WA</p>
                  <p class="post-author-website">
                    <a href="https://apoch.github.io/" rel="nofollow">https://apoch.github.io/</a>
                  </p>
                <p class="post-info">
                  <b class="post-info-title">Published on</b>
                  <time class="post-date">May 29, 2017</time>
                </p>
              </div>
            </div>
            <div class="post-social">
              <h4 class="post-footer-heading">Spread the word</h4>
              <a href="#" data-action="share-twitter"><i class="fa fa-fw fa-lg fa-twitter"></i></a>
              <a href="#" data-action="share-facebook"><i class="fa fa-fw fa-lg fa-facebook"></i></a>
              <a href="#" data-action="share-gplus"><i class="fa fa-fw fa-lg fa-google-plus"></i></a>
            </div>
          </footer>
        </section>
      <section itemprop="comment" class="post-comments">
        <div id="disqus_thread"></div>
      </section>
    </article>

    <footer role="contentinfo" class="footer">
      <p><small>Copyright &copy; <span itemprop="copyrightHolder">The Bag of Holding</span>. 2017. All Rights Reserved.</small></p>
      <p><small><a href="http://ghostium.oswaldoacauan.com/" target="_blank">Ghostium Theme</a> by <a href="http://twitter.com/oswaldoacauan" target="_blank">@oswaldoacauan</a></small></p>
      <p><small>Adapted by <a href="https://twitter.com/mgreau">Maxime Gréau</a></small></p>
      <p><small>Published with <a href="http://hubpress.io">HubPress</a></small></p>
    </footer>
  </div>
</section>


          </div>
        </div>
      </div>
    </main>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

    <script src="//apoch.github.io/blog/themes/ghostium/assets/js/foot-scripts.min.js?v=1496373426181"></script>


  </body>
</html>
